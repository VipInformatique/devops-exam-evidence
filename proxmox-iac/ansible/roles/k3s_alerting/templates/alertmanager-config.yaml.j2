route:
  receiver: "devistor-default"
  group_by: ["alertname","severity"]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 2h
  routes:
    - receiver: "devistor-critical"
      matchers: [ 'severity="critical"' ]
      group_wait: 10s
      group_interval: 1m
      repeat_interval: 1h
    - receiver: "devistor-ops"
      matchers: [ 'severity="warning"' ]
      group_wait: 15s
      group_interval: 2m
      repeat_interval: 2h
    # ‚Äûsink‚Äù ‚Äì celowo nic nie wysy≈Ça (do wyciszania ha≈Ça≈õliwych alert√≥w)
    - receiver: "devistor-drop"
      matchers:
        - alertname=~"Kube(Scheduler|ControllerManager|Proxy)Down"

# Gasi warningi, je≈õli dla tego samego obiektu jest ju≈º critical
inhibit_rules:
  - source_matchers: [ 'severity="critical"' ]
    target_matchers: [ 'severity="warning"' ]
    equal: ["alertname","namespace","pod","instance","node","persistentvolumeclaim","mountpoint"]

receivers:
  - name: "devistor-default"
    telegram_configs:
      - bot_token: "{{ telegram_bot_token }}"
        chat_id: {{ telegram_chat_id_ops | int }}
        send_resolved: true
        message: |-
          {% raw -%}
          [{{ .Status | toUpper }}] {{ if .GroupLabels.alertname }}{{ .GroupLabels.alertname }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}
          {{- range .Alerts }}
          ‚Ä¢ {{ .Labels.alertname }}
            where:{{ if .Labels.namespace }} ns={{ .Labels.namespace }}{{ end }}{{ if .Labels.pod }} pod={{ .Labels.pod }}{{ end }}{{ if .Labels.node }} node={{ .Labels.node }}{{ else if .Labels.instance }} instance={{ .Labels.instance }}{{ end }}{{ if .Labels.persistentvolumeclaim }} pvc={{ .Labels.persistentvolumeclaim }}{{ end }}{{ if .Labels.mountpoint }} mount={{ .Labels.mountpoint }}{{ end }}{{ if .Labels.schedule }} schedule={{ .Labels.schedule }}{{ end }}{{ if .Labels.vm_name }} vm={{ .Labels.vm_name }}{{ end }}{{ if .Labels.vm_id }} vmid={{ .Labels.vm_id }}{{ end }}{{ if .Labels.datastore }} ds={{ .Labels.datastore }}{{ end }}
            why: {{ if .Annotations.summary }}{{ .Annotations.summary }}{{ else if .Annotations.description }}{{ .Annotations.description }}{{ else }}(no summary){{ end }}
            when: {{ .StartsAt.Local.Format "2006-01-02 15:04:05 MST" }}
          {{- else }}(no alerts in group){{- end }}
          {%- endraw %}

  - name: "devistor-ops"
    telegram_configs:
      - bot_token: "{{ telegram_bot_token }}"
        chat_id: {{ telegram_chat_id_ops | int }}
        send_resolved: true
        message: |-
          {% raw -%}
          [{{ .Status | toUpper }}] {{ if .GroupLabels.alertname }}{{ .GroupLabels.alertname }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}
          {{- range .Alerts }}
          ‚Ä¢ {{ .Labels.alertname }}
            where:{{ if .Labels.namespace }} ns={{ .Labels.namespace }}{{ end }}{{ if .Labels.pod }} pod={{ .Labels.pod }}{{ end }}{{ if .Labels.node }} node={{ .Labels.node }}{{ else if .Labels.instance }} instance={{ .Labels.instance }}{{ end }}{{ if .Labels.persistentvolumeclaim }} pvc={{ .Labels.persistentvolumeclaim }}{{ end }}{{ if .Labels.mountpoint }} mount={{ .Labels.mountpoint }}{{ end }}{{ if .Labels.schedule }} schedule={{ .Labels.schedule }}{{ end }}{{ if .Labels.vm_name }} vm={{ .Labels.vm_name }}{{ end }}{{ if .Labels.vm_id }} vmid={{ .Labels.vm_id }}{{ end }}{{ if .Labels.datastore }} ds={{ .Labels.datastore }}{{ end }}
            why: {{ if .Annotations.summary }}{{ .Annotations.summary }}{{ else if .Annotations.description }}{{ .Annotations.description }}{{ else }}(no summary){{ end }}
            when: {{ .StartsAt.Local.Format "2006-01-02 15:04:05 MST" }}
          {{- else }}(no alerts in group){{- end }}
          {%- endraw %}

  - name: "devistor-critical"
    telegram_configs:
      - bot_token: "{{ telegram_bot_token }}"
        chat_id: {{ telegram_chat_id_oncall | int }}
        send_resolved: true
        message: |-
          {% raw -%}
          [{{ .Status | toUpper }}] {{ if .GroupLabels.alertname }}{{ .GroupLabels.alertname }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}
          {{- range .Alerts }}
          üî¥ {{ .Labels.alertname }}
            where:{{ if .Labels.namespace }} ns={{ .Labels.namespace }}{{ end }}{{ if .Labels.pod }} pod={{ .Labels.pod }}{{ end }}{{ if .Labels.node }} node={{ .Labels.node }}{{ else if .Labels.instance }} instance={{ .Labels.instance }}{{ end }}{{ if .Labels.persistentvolumeclaim }} pvc={{ .Labels.persistentvolumeclaim }}{{ end }}{{ if .Labels.mountpoint }} mount={{ .Labels.mountpoint }}{{ end }}{{ if .Labels.schedule }} schedule={{ .Labels.schedule }}{{ end }}{{ if .Labels.vm_name }} vm={{ .Labels.vm_name }}{{ end }}{{ if .Labels.vm_id }} vmid={{ .Labels.vm_id }}{{ end }}{{ if .Labels.datastore }} ds={{ .Labels.datastore }}{{ end }}
            why: {{ if .Annotations.summary }}{{ .Annotations.summary }}{{ else if .Annotations.description }}{{ .Annotations.description }}{{ else }}(no summary){{ end }}
            when: {{ .StartsAt.Local.Format "2006-01-02 15:04:05 MST" }}
          {{- else }}(no alerts in group){{- end }}
          {%- endraw %}

  - name: "devistor-drop"
